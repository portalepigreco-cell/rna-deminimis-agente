<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RNA De Minimis</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d30 100%);
            color: #e4e4e4;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px;
            background: rgba(42, 42, 46, 0.95);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
        }

        h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #4a9eff;
            font-size: 2.5em;
            font-weight: 600;
        }

        .subtitle {
            text-align: center;
            margin-bottom: 30px;
            color: #a0a0a0;
            font-size: 1.1em;
        }

        .mode-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #333;
            padding: 5px;
            border-radius: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 15px;
            background: transparent;
            border: none;
            color: #a0a0a0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .mode-btn.active {
            background: #4a9eff;
            color: white;
        }

        .mode-btn:hover:not(.active) {
            background: #555;
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        .database-info {
            background: #2a2a2a;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 3px solid #2ed573;
        }

        .database-info h3 {
            color: #2ed573;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .database-info p {
            color: #a0a0a0;
            font-size: 0.9em;
            line-height: 1.4;
        }

        .piva-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .piva-item {
            background: #3c3c3c;
            padding: 8px 12px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        textarea {
            width: 100%;
            min-height: 120px;
            padding: 15px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 8px;
            color: #e4e4e4;
            font-size: 16px;
            font-family: 'Courier New', monospace;
            resize: vertical;
            transition: border-color 0.3s;
        }

        textarea:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
        }

        .entry-section {
            margin-bottom: 20px;
        }

        .entry-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: center;
            background: #333;
            padding: 15px;
            border-radius: 8px;
        }

        .entry-row input[type="text"] {
            flex: 1;
            padding: 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e4e4e4;
            font-family: 'Courier New', monospace;
        }

        .entry-row input[type="number"] {
            flex: 1;
            padding: 10px;
            background: #3c3c3c;
            border: 1px solid #555;
            border-radius: 5px;
            color: #e4e4e4;
            text-align: right;
        }

        .entry-row input:focus {
            outline: none;
            border-color: #4a9eff;
            box-shadow: 0 0 0 2px rgba(74, 158, 255, 0.2);
        }

        .remove-btn {
            background: #ff4757;
            border: none;
            color: white;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .add-btn {
            background: #2ed573;
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #4a9eff 0%, #0066cc 100%);
            border: none;
            color: white;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            width: 100%;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(74, 158, 255, 0.4);
        }

        .btn:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            display: none;
            text-align: center;
            margin: 20px 0;
            color: #4a9eff;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid #4a9eff;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .results {
            margin-top: 30px;
            display: none;
        }

        .result-item {
            background: #333;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4a9eff;
            transition: transform 0.2s;
        }

        .result-item:hover {
            transform: translateX(5px);
        }

        .result-item.error {
            border-left-color: #ff4757;
            background: rgba(255, 71, 87, 0.1);
        }

        .result-item.warning {
            border-left-color: #ffa502;
            background: rgba(255, 165, 2, 0.1);
        }

        .result-item.success {
            border-left-color: #2ed573;
            background: rgba(46, 213, 115, 0.1);
        }

        .result-item.no-data {
            border-left-color: #747d8c;
            background: rgba(116, 125, 140, 0.1);
        }

        .piva {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #4a9eff;
            font-family: 'Courier New', monospace;
        }

        .amount {
            font-size: 2em;
            font-weight: bold;
            margin: 10px 0;
        }

        .amount.zero { color: #747d8c; }
        .amount.low { color: #2ed573; }
        .amount.medium { color: #ffa502; }
        .amount.high { color: #ff4757; }

        .details {
            font-size: 0.9em;
            color: #a0a0a0;
            margin-top: 10px;
        }

        .fonte {
            font-size: 0.8em;
            color: #555;
            font-style: italic;
            margin-top: 5px;
        }

        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid #444;
            color: #888;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><img src="/static/img/ideogramma-bianco.png" alt="RNA De Minimis" style="width: 100px; margin-right: 10px;"> RNA De Minimis</h1>
        
        <div class="mode-selector">
            <button class="mode-btn active" onclick="switchMode('auto')">De Minimis</button>
            <!-- <button class="mode-btn" onclick="switchMode('manual')">Collegate (archivio)</button> -->
            <button class="mode-btn" onclick="switchMode('cribis')">Ricerca controllate</button>
        </div>
        
        <!-- Modalit√† Automatica -->
        <div id="auto-mode" class="mode-content active">
            <label for="partite-iva-auto">Codici Fiscali (uno per riga):</label>
            <div style="display: flex; gap: 15px; align-items: stretch;">
                <textarea 
                    id="partite-iva-auto" 
                    placeholder="03254550738&#10;04108170962&#10;01392840417"
                    rows="4"
                    style="flex: 1; min-height: 100px;"
                ></textarea>
                
                <button class="btn" onclick="calcolaAutomatico()" style="flex: 0 0 200px; height: auto; white-space: nowrap;">
                    üîÑ Calcola De Minimis
                </button>
            </div>
        </div>
        
        <!-- Modalit√† Archivio Cribis - TEMPORANEAMENTE DISABILITATA -->
        <!-- 
        <div id="manual-mode" class="mode-content">
            <div class="database-info" style="border-left-color: #28a745;">
                <h3 style="color: #28a745;">üè¢ Calcolo Aggregato (con Ricerca Collegate)</h3>
                <p>Ricerca automaticamente le societ√† collegate con controllo <strong>>50%</strong> tramite <strong>archivio Cribis X</strong> e calcola il De Minimis complessivo del gruppo.</p>
                <p style="margin-top: 10px; color: #28a745;">‚úÖ Utilizza report gi√† generati (nessun consumo crediti)</p>
            </div>
            
            <label for="partita-iva-archivio">Codice Fiscale:</label>
            <div style="display: flex; gap: 15px; align-items: stretch;">
                <input 
                    type="text" 
                    id="partita-iva-archivio" 
                    placeholder="02918700168" 
                    maxlength="16"
                    style="flex: 1; padding: 15px; font-size: 1.1em; background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 8px;"
                >
                
                <button class="btn" onclick="calcolaArchivio()" style="flex: 0 0 200px; height: auto; background: linear-gradient(135deg, #28a745, #20c997); white-space: nowrap;">
                    üè¢ Calcola Gruppo
                </button>
            </div>
            
            <div id="archivio-results" class="results-section" style="display: none; margin-top: 30px;">
                <h2 style="color: #28a745; margin-bottom: 20px;">üìã Risultati De Minimis Aggregato</h2>
                <div id="archivio-results-content"></div>
                <div style="margin-top: 20px; text-align: right;">
                    <button id="copy-archivio-markdown-btn" 
                        style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        üìã Copia Markdown
                    </button>
                </div>
            </div>
        </div>
        -->
        
        <!-- Modalit√† Cribis - Nuova Ricerca -->
        <div id="cribis-mode" class="mode-content">
            <div class="database-info" style="border-left-color: #ff6b6b;">
                <h3 style="color: #ff6b6b;">üè¢ Nuova Ricerca Cribis X</h3>
                <p>Genera un <strong>NUOVO report Gruppo Societario</strong> in tempo reale.</p>
                <p style="margin-top: 10px; color: #ffaa00;">‚ö†Ô∏è Questa operazione consuma crediti Cribis e richiede 1-3 minuti.</p>
                <p style="margin-top: 5px; font-size: 0.9em;">‚úÖ Estrae automaticamente tutte le societ√† italiane controllate >50%</p>
            </div>
            
            <label for="partita-iva-cribis">Partita IVA (singola):</label>
            <div style="display: flex; gap: 15px; align-items: stretch;">
                <input 
                    type="text" 
                    id="partita-iva-cribis" 
                    placeholder="04703370165" 
                    maxlength="11"
                    style="flex: 1; padding: 15px; font-size: 1.1em; background: #2a2a2a; color: #fff; border: 1px solid #555; border-radius: 8px;"
                >
                
                <button class="btn" onclick="avviaNuovaRicercaCribis()" style="flex: 0 0 200px; height: auto; background: linear-gradient(135deg, #ff6b6b, #ff8e53); white-space: nowrap;">
                    üìã Ricerca in Cribis
                </button>
            </div>
        </div>
        
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Elaborazione in corso... ‚è≥</p>
        </div>
        
        <div class="results" id="results"></div>
        
       
    </div>

    <script>
        let currentMode = 'auto';
        
        function switchMode(mode) {
            currentMode = mode;
            
            // Aggiorna bottoni
            document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[onclick="switchMode('${mode}')"]`).classList.add('active');
            
            // Mostra/nascondi contenuti
            document.querySelectorAll('.mode-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${mode}-mode`).classList.add('active');
        }
        
        async function calcolaAutomatico() {
            const textarea = document.getElementById('partite-iva-auto');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Inserisci almeno una Partita IVA');
                return;
            }
            
            const partiteIva = text.split('\n')
                .map(line => line.trim())
                .filter(line => line.length > 0);
            
            if (partiteIva.length === 0) {
                alert('Inserisci almeno una Partita IVA valida');
                return;
            }
            
            await eseguiCalcolo({ mode: 'auto', partite_iva: partiteIva });
        }
        
        async function calcolaArchivio() {
            const pivaInput = document.getElementById('partita-iva-archivio');
            const piva = pivaInput.value.trim();
            
            if (!piva) {
                alert('‚ö†Ô∏è Inserisci un Codice Fiscale');
                return;
            }
            
            if (!/^\d{11,16}$/.test(piva)) {
                alert('‚ö†Ô∏è Il Codice Fiscale deve essere di 11-16 cifre');
                return;
            }
            
            document.getElementById('loading').style.display = 'block';
            document.getElementById('archivio-results').style.display = 'none';
            
            try {
                const response = await fetch('/calcola', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'aggregato', partita_iva: piva })
                });
                
                const data = await response.json();
                document.getElementById('loading').style.display = 'none';
                
                if (!response.ok) {
                    let messaggioErrore = data.errore || 'Errore sconosciuto';
                    
                    // Errore specifico per azienda non trovata nell'archivio
                    if (messaggioErrore.includes("non trovata") || messaggioErrore.includes("non presente")) {
                        alert("‚ö†Ô∏è Azienda non presente nell'archivio, usa il tab 'Partecipate (Nuova Ricerca)'");
                    } else {
                        alert(`‚ùå ${messaggioErrore}`);
                    }
                    return;
                }
                
                mostraRisultatiArchivio(data);
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert(`‚ùå Errore di rete: ${error.message}`);
            }
        }
        
        // Variabile globale per risultato Archivio
        let risultatoArchivioGlobale = null;
        
        function mostraRisultatiArchivio(risultato) {
            const resultsDiv = document.getElementById('archivio-results-content');
            resultsDiv.innerHTML = '';
            document.getElementById('archivio-results').style.display = 'block';
            
            risultatoArchivioGlobale = risultato;  // Salva globalmente
            
            let htmlContent = `
                <div class="result-card ${risultato.stato}">
                    <div class="result-header">
                        <span class="status-icon">
                            ${risultato.stato === 'ok' ? '‚úÖ' : 
                              risultato.stato === 'attenzione' ? '‚ö†Ô∏è' : 
                              risultato.stato === 'superata' ? '‚ùå' : 
                              risultato.stato === 'nessun_aiuto' ? 'üëç' : '‚ùì'}
                        </span>
                        <h3 style="margin: 0;">${risultato.partita_iva}</h3>
                        <div style="margin-left: auto;">
                            <button onclick="copiaMarkdownArchivioGlobal()" 
                                style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                                üìã Copia Markdown
                            </button>
                        </div>
                    </div>
                    
                    <div class="result-summary">
                        <div class="summary-item">
                            <span class="label">Totale De Minimis:</span>
                            <span class="value highlight-value">${formatEuro(risultato.totale_de_minimis)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Numero aiuti:</span>
                            <span class="value">${risultato.numero_societa || 0}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Percentuale:</span>
                            <span class="value">${risultato.percentuale_utilizzata}%</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Margine:</span>
                            <span class="value">${formatEuro(risultato.margine_rimanente)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Data:</span>
                            <span class="value">${risultato.data_ricerca}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Fonte:</span>
                            <span class="value">${risultato.fonte}</span>
                        </div>
                    </div>
            `;
            
            // Mostra societ√† del gruppo se disponibili
            if (risultato.dettaglio_societa && risultato.dettaglio_societa.length > 0) {
                htmlContent += `
                    <div style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                        <h3 style="color: #28a745; margin: 0 0 12px 0; font-size: 1em;">üè¢ Societ√† del Gruppo (${risultato.dettaglio_societa.length}):</h3>
                `;
                
                risultato.dettaglio_societa.forEach((societa, idx) => {
                    const importo = formatEuro(societa.totale_de_minimis || 0);
                    const statoIcon = societa.stato === 'ok' ? '‚úÖ' : societa.stato === 'attenzione' ? '‚ö†Ô∏è' : '‚ùå';
                    
                    htmlContent += `
                        <div style="padding: 10px; margin: 8px 0; background: #333; border-radius: 5px; border-left: 3px solid #28a745;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <span style="font-weight: 600; color: #28a745;">${statoIcon} ${societa.codice_fiscale}</span>
                                <span style="color: #e4e4e4; font-weight: 600;">${importo}</span>
                            </div>
                            <div style="color: #a0a0a0; font-size: 0.9em;">
                                Aiuti: ${societa.numero_aiuti || 0}
                            </div>
                        </div>
                    `;
                });
                
                htmlContent += `</div>`;
            }
            
            // Mostra dettaglio aiuti aggregato
            if (risultato.dettaglio_societa && risultato.dettaglio_societa.some(s => s.aiuti_trovati && s.aiuti_trovati.length > 0)) {
                htmlContent += `
                    <div style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                        <h3 style="color: #28a745; margin: 0 0 12px 0; font-size: 1em;">üìù Dettaglio Aiuti (Aggregato):</h3>
                `;
                
                // Raccogli tutti gli aiuti da tutte le societ√†
                let tuttiAiuti = [];
                risultato.dettaglio_societa.forEach(societa => {
                    if (societa.aiuti_trovati && societa.aiuti_trovati.length > 0) {
                        societa.aiuti_trovati.forEach(aiuto => {
                            tuttiAiuti.push({
                                ...aiuto,
                                societa_cf: societa.codice_fiscale
                            });
                        });
                    }
                });
                
                // Ordina per data
                tuttiAiuti.sort((a, b) => new Date(b.data_concessione || b.data) - new Date(a.data_concessione || a.data));
                
                tuttiAiuti.forEach((aiuto, idx) => {
                    const importoAiuto = formatEuro(aiuto.importo);
                    htmlContent += `
                        <div style="padding: 10px; margin: 8px 0; background: #333; border-radius: 5px; border-left: 3px solid #28a745;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #28a745;">${importoAiuto}</span>
                                <span style="color: #a0a0a0; font-size: 0.9em;">üìÖ ${aiuto.data_concessione || aiuto.data}</span>
                            </div>
                            <div style="color: #e4e4e4; font-size: 0.95em; line-height: 1.4; margin-bottom: 5px;">
                                ${aiuto.titolo_misura || 'Titolo non disponibile'}
                            </div>
                            <div style="color: #a0a0a0; font-size: 0.85em;">
                                üìç Societ√†: ${aiuto.societa_cf}
                            </div>
                        </div>
                    `;
                });
                
                htmlContent += `</div>`;
            } else {
                htmlContent += `
                    <div style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                        <p style="color: #a0a0a0;">Nessun aiuto De Minimis trovato per il gruppo.</p>
                    </div>
                `;
            }
            
            htmlContent += `</div>`;
            resultsDiv.innerHTML = htmlContent;
        }
        
        function copiaMarkdownArchivioGlobal() {
            if (!risultatoArchivioGlobale) {
                alert('‚ùå Errore: dati non trovati');
                return;
            }
            copiaMarkdownArchivio(risultatoArchivioGlobale);
        }
        
        function copiaMarkdownArchivio(risultato) {
            let markdown = `## üìã Risultato De Minimis Aggregato - ${risultato.partita_iva}\n\n`;
            
            // Societ√† del gruppo
            if (risultato.dettaglio_societa && risultato.dettaglio_societa.length > 0) {
                markdown += `### üè¢ Societ√† del Gruppo (${risultato.dettaglio_societa.length}):\n`;
                risultato.dettaglio_societa.forEach(societa => {
                    const importo = formatEuro(societa.totale_de_minimis || 0);
                    markdown += `- **${societa.codice_fiscale}**: ${importo} (${societa.numero_aiuti || 0} aiuti)\n`;
                });
                markdown += `\n`;
            }
            
            // Dettaglio aiuti
            if (risultato.dettaglio_societa && risultato.dettaglio_societa.some(s => s.aiuti_trovati && s.aiuti_trovati.length > 0)) {
                markdown += `### üìù Dettaglio Aiuti (Aggregato):\n`;
                markdown += `| Data | Importo | Titolo Misura | Societ√† |\n`;
                markdown += `|------|---------|---------------|----------|\n`;
                
                let tuttiAiuti = [];
                risultato.dettaglio_societa.forEach(societa => {
                    if (societa.aiuti_trovati && societa.aiuti_trovati.length > 0) {
                        societa.aiuti_trovati.forEach(aiuto => {
                            tuttiAiuti.push({
                                ...aiuto,
                                societa_cf: societa.codice_fiscale
                            });
                        });
                    }
                });
                
                tuttiAiuti.sort((a, b) => new Date(b.data_concessione || b.data) - new Date(a.data_concessione || a.data));
                
                tuttiAiuti.forEach(aiuto => {
                    const importoFormat = formatEuro(aiuto.importo).replace('‚Ç¨', '‚Ç¨ ');
                    const titolo = aiuto.titolo_misura || 'N/A';
                    const data = aiuto.data_concessione || aiuto.data;
                    markdown += `| ${data} | ${importoFormat} | ${titolo} | ${aiuto.societa_cf} |\n`;
                });
                markdown += `\n`;
            } else {
                markdown += `Nessun aiuto De Minimis trovato per il gruppo.\n\n`;
            }
            
            const totaleFormat = formatEuro(risultato.totale_de_minimis);
            const margineFormat = formatEuro(risultato.margine_rimanente);
            markdown += `**Totale De Minimis Aggregato**: ${totaleFormat}\n`;
            markdown += `**Numero societ√†**: ${risultato.numero_societa || 0}\n`;
            markdown += `**Percentuale utilizzata**: ${risultato.percentuale_utilizzata}%\n`;
            markdown += `**Margine rimanente**: ${margineFormat}\n`;
            markdown += `**Data ricerca**: ${risultato.data_ricerca}\n`;
            markdown += `**Fonte**: ${risultato.fonte}\n`;
            
            navigator.clipboard.writeText(markdown).then(() => {
                alert('‚úÖ Risultato aggregato copiato in formato Markdown!');
            }).catch(err => {
                alert('‚ùå Errore nella copia: ' + err);
            });
        }
        
        async function eseguiCalcolo(payload) {
            const loading = document.getElementById('loading');
            const results = document.getElementById('results');
            const btn = document.querySelector('.btn');
            
            btn.disabled = true;
            loading.style.display = 'block';
            results.style.display = 'none';
            
            try {
                const response = await fetch('/calcola', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.errore) {
                    throw new Error(data.errore);
                }
                
                mostraRisultati(data.risultati);
                
            } catch (error) {
                alert('Errore: ' + error.message);
            } finally {
                btn.disabled = false;
                loading.style.display = 'none';
            }
        }
        
        function generaMarkdown(risultato) {
            // Genera tabella markdown dai risultati
            let markdown = `## üìã Risultato De Minimis - ${risultato.partita_iva}\n\n`;
            
            if (risultato.aiuti_trovati && risultato.aiuti_trovati.length > 0) {
                markdown += `| Data | Importo | Titolo Misura |\n`;
                markdown += `|------|---------|---------------|\n`;
                
                risultato.aiuti_trovati.forEach(aiuto => {
                    const importoFormat = formatEuro(aiuto.importo).replace('‚Ç¨', '‚Ç¨ ');
                    const titolo = aiuto.titolo_misura || 'N/A';
                    markdown += `| ${aiuto.data_concessione} | ${importoFormat} | ${titolo} |\n`;
                });
                
                markdown += `\n`;
            }
            
            const totaleFormat = formatEuro(risultato.totale_de_minimis);
            const margineFormat = formatEuro(risultato.margine_rimanente);
            
            markdown += `**Totale De Minimis**: ${totaleFormat}\n`;
            markdown += `**Numero aiuti**: ${risultato.numero_aiuti}\n`;
            markdown += `**Percentuale utilizzata**: ${risultato.percentuale_utilizzata}%\n`;
            markdown += `**Margine rimanente**: ${margineFormat}\n`;
            markdown += `**Data ricerca**: ${risultato.data_ricerca}\n`;
            
            return markdown;
        }
        
        function copiaMarkdownByIndex(index) {
            const risultato = risultatiGlobali[index];
            if (!risultato) {
                alert('‚ùå Errore: risultato non trovato');
                return;
            }
            const markdown = generaMarkdown(risultato);
            
            navigator.clipboard.writeText(markdown).then(() => {
                alert('‚úÖ Risultato copiato in formato Markdown!');
            }).catch(err => {
                alert('‚ùå Errore nella copia: ' + err);
            });
        }
        
        function copiaMarkdown(risultato) {
            const markdown = generaMarkdown(risultato);
            
            navigator.clipboard.writeText(markdown).then(() => {
                alert('‚úÖ Risultato copiato in formato Markdown!');
            }).catch(err => {
                alert('‚ùå Errore nella copia: ' + err);
            });
        }
        
        // Variabile globale per memorizzare i risultati
        let risultatiGlobali = [];
        
        function mostraRisultati(risultati) {
            const resultsDiv = document.getElementById('results');
            risultatiGlobali = risultati;  // Salva i risultati globalmente
            
            let html = '<h2>üìã Risultati De Minimis</h2>';
            
            risultati.forEach((risultato, index) => {
                let cssClass = 'result-item';
                let amountClass = 'amount';
                let statusIcon = '';
                
                if (risultato.errore) {
                    cssClass += ' error';
                    statusIcon = '‚ùå';
                    amountClass += ' zero';
                } else if (risultato.stato === 'nessun_aiuto') {
                    cssClass += ' no-data';
                    statusIcon = 'üìä';
                    amountClass += ' zero';
                } else if (risultato.stato === 'superata') {
                    cssClass += ' error';
                    statusIcon = 'üö®';
                    amountClass += ' high';
                } else if (risultato.stato === 'attenzione') {
                    cssClass += ' warning';
                    statusIcon = '‚ö†Ô∏è';
                    amountClass += ' medium';
                } else {
                    cssClass += ' success';
                    statusIcon = '‚úÖ';
                    amountClass += ' low';
                }
                
                html += `<div class="${cssClass}">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div class="piva">${statusIcon} ${risultato.partita_iva}</div>`;
                
                // Aggiungi bottone Copia Markdown se ci sono dati validi
                if (!risultato.errore && risultato.aiuti_trovati) {
                    html += `<button onclick="copiaMarkdownByIndex(${index})" 
                        style="padding: 8px 16px; background: #4a9eff; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                        üìã Copia Markdown
                    </button>`;
                }
                
                html += `</div>`;
                
                if (risultato.errore) {
                    html += `<div style="color: #ff4757; font-weight: 500;">${risultato.errore}</div>`;
                } else {
                    const totaleFormatted = formatEuro(risultato.totale_de_minimis);
                    const margineFormatted = formatEuro(risultato.margine_rimanente);
                    
                    html += `
                        <div class="${amountClass}">${totaleFormatted}</div>
                        <div class="details">
                    `;
                    
                    if (risultato.numero_aiuti !== undefined) {
                        html += `üìä ${risultato.numero_aiuti} aiuti trovati<br>`;
                    }
                    
                    html += `
                            üìà ${risultato.percentuale_utilizzata}% del limite utilizzato<br>
                            üí∞ Margine disponibile: ${margineFormatted}<br>
                            üìÖ ${risultato.data_ricerca}
                        </div>
                    `;
                    
                    // Mostra dettagli aiuti se presenti
                    if (risultato.aiuti_trovati && risultato.aiuti_trovati.length > 0) {
                        html += `<div style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px;">`;
                        html += `<h3 style="color: #4a9eff; margin: 0 0 12px 0; font-size: 1em;">üìù Dettaglio Aiuti:</h3>`;
                        
                        risultato.aiuti_trovati.forEach((aiuto, idx) => {
                            const importoAiuto = formatEuro(aiuto.importo);
                            html += `
                                <div style="padding: 10px; margin: 8px 0; background: #333; border-radius: 5px; border-left: 3px solid #4a9eff;">
                                    <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                                        <span style="font-weight: 600; color: #4a9eff;">${importoAiuto}</span>
                                        <span style="color: #a0a0a0; font-size: 0.9em;">üìÖ ${aiuto.data_concessione || aiuto.data}</span>
                                    </div>
                                    <div style="color: #e4e4e4; font-size: 0.95em; line-height: 1.4;">
                                        ${aiuto.titolo_misura || 'Titolo non disponibile'}
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += `</div>`;
                    }
                    
                    if (risultato.fonte) {
                        html += `<div class="fonte">Fonte: ${risultato.fonte}</div>`;
                    }
                    
                    if (risultato.note) {
                        html += `<div class="fonte">${risultato.note}</div>`;
                    }
                }
                
                html += '</div>';
            });
            
            resultsDiv.innerHTML = html;
            resultsDiv.style.display = 'block';
        }
        
        function formatEuro(amount) {
            return new Intl.NumberFormat('it-IT', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            }).format(amount);
        }
        
        // Validazione P.IVA
        document.addEventListener('input', function(e) {
            if (e.target.classList.contains('piva-input')) {
                e.target.value = e.target.value.replace(/[^0-9]/g, '');
            }
        });
        
        // Auto-resize textarea
        const textarea = document.getElementById('partite-iva-auto');
        if (textarea) {
            textarea.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
            });
        }
        
        // ===== NUOVA RICERCA CRIBIS =====
        async function avviaNuovaRicercaCribis() {
            const pivaInput = document.getElementById('partita-iva-cribis');
            const piva = pivaInput.value.trim();
            
            // Validazione
            if (!piva) {
                alert('‚ö†Ô∏è Inserisci una Partita IVA');
                return;
            }
            
            if (!/^\d{11}$/.test(piva)) {
                alert('‚ö†Ô∏è La Partita IVA deve essere di 11 cifre');
                return;
            }
            
            // Conferma (operazione lunga e costosa)
            if (!confirm(`üè¢ Avviare Nuova Ricerca Cribis per P.IVA ${piva}?\n\n‚ö†Ô∏è Questa operazione:\n‚Ä¢ Genera un NUOVO report\n‚Ä¢ Consuma crediti Cribis\n‚Ä¢ Richiede 1-3 minuti\n\nContinuare?`)) {
                return;
            }
            
            // Mostra loading
            document.getElementById('loading').style.display = 'block';
            document.getElementById('results').style.display = 'none';
            
            try {
                const response = await fetch('/cribis_nuova_ricerca', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ partita_iva: piva })
                });
                
                const data = await response.json();
                
                // Nascondi loading
                document.getElementById('loading').style.display = 'none';
                
                if (!response.ok) {
                    // Mostra errore con dettaglio se disponibile
                    let messaggioErrore = data.errore || 'Errore sconosciuto';
                    if (data.dettaglio) {
                        messaggioErrore += '\n\n' + data.dettaglio;
                    }
                    alert(`‚ùå ${messaggioErrore}`);
                    return;
                }
                
                // Mostra risultati Cribis
                mostraRisultatiCribis(data);
                
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                alert(`‚ùå Errore di rete: ${error.message}`);
            }
        }
        
        // Variabile globale per risultato Cribis
        let risultatoCribisGlobale = null;
        
        function mostraRisultatiCribis(data) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';
            resultsDiv.style.display = 'block';
            
            risultatoCribisGlobale = data;  // Salva globalmente
            
            let htmlContent = `
                <h2 style="color: #ff6b6b; margin-bottom: 20px;">üìã Risultati De Minimis Aggregato</h2>
                <div class="result-card ${data.stato || 'success'}">
                    <div class="result-header">
                        <span class="status-icon">
                            ${data.stato === 'ok' ? '‚úÖ' : 
                              data.stato === 'attenzione' ? '‚ö†Ô∏è' : 
                              data.stato === 'superata' ? '‚ùå' : 
                              data.stato === 'nessun_aiuto' ? 'üëç' : '‚úÖ'}
                        </span>
                        <h3 style="margin: 0;">${data.partita_iva}</h3>
                        <div style="margin-left: auto;">
                            <button onclick="copiaMarkdownCribisGlobal()" 
                                style="padding: 8px 16px; background: #ff6b6b; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: 600;">
                                üìã Copia Markdown
                            </button>
                        </div>
                    </div>
                    
                    <div class="result-summary">
                        <div class="summary-item">
                            <span class="label">Totale De Minimis:</span>
                            <span class="value highlight-value">${formatEuro(data.totale_de_minimis || 0)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Numero aiuti:</span>
                            <span class="value">${data.numero_aiuti || 0}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Percentuale:</span>
                            <span class="value">${data.percentuale_utilizzata || 0}%</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Margine:</span>
                            <span class="value">${formatEuro(data.margine_rimanente || 0)}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Associate trovate:</span>
                            <span class="value">${data.numero_associate || 0}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Data ricerca:</span>
                            <span class="value">${data.data_ricerca}</span>
                        </div>
                        <div class="summary-item">
                            <span class="label">Fonte:</span>
                            <span class="value">${data.fonte || 'Cribis Nuova Ricerca'}</span>
                        </div>
                    </div>
            `;
            
            // Mostra societ√† del gruppo se disponibili
            if (data.dettaglio_societa && data.dettaglio_societa.length > 0) {
                htmlContent += `
                    <div style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                        <h3 style="color: #ff6b6b; margin: 0 0 12px 0; font-size: 1em;">üè¢ Societ√† del Gruppo (${data.dettaglio_societa.length}):</h3>
                `;
                
                data.dettaglio_societa.forEach((societa, idx) => {
                    const importo = formatEuro(societa.totale_de_minimis || 0);
                    const statoIcon = societa.stato === 'ok' ? '‚úÖ' : societa.stato === 'attenzione' ? '‚ö†Ô∏è' : '‚ùå';
                    
                    htmlContent += `
                        <div style="padding: 10px; margin: 8px 0; background: #333; border-radius: 5px; border-left: 3px solid #ff6b6b;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline;">
                                <span style="font-weight: 600; color: #ff6b6b;">${statoIcon} ${societa.codice_fiscale}</span>
                                <span style="color: #e4e4e4; font-weight: 600;">${importo}</span>
                            </div>
                            <div style="color: #a0a0a0; font-size: 0.9em;">
                                Aiuti: ${societa.numero_aiuti || 0}
                            </div>
                        </div>
                    `;
                });
                
                htmlContent += `</div>`;
            }
            
            // Mostra dettaglio aiuti aggregato
            if (data.tutti_aiuti && data.tutti_aiuti.length > 0) {
                htmlContent += `
                    <div style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                        <h3 style="color: #ff6b6b; margin: 0 0 12px 0; font-size: 1em;">üìù Dettaglio Aiuti (Aggregato):</h3>
                `;
                
                data.tutti_aiuti.forEach((aiuto, idx) => {
                    const importoAiuto = formatEuro(aiuto.importo);
                    htmlContent += `
                        <div style="padding: 10px; margin: 8px 0; background: #333; border-radius: 5px; border-left: 3px solid #ff6b6b;">
                            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 5px;">
                                <span style="font-weight: 600; color: #ff6b6b;">${importoAiuto}</span>
                                <span style="color: #a0a0a0; font-size: 0.9em;">üìÖ ${aiuto.data_concessione || aiuto.data}</span>
                            </div>
                            <div style="color: #e4e4e4; font-size: 0.95em; line-height: 1.4; margin-bottom: 5px;">
                                ${aiuto.titolo_misura || 'Titolo non disponibile'}
                            </div>
                            <div style="color: #a0a0a0; font-size: 0.85em;">
                                üìç Societ√†: ${aiuto.societa_cf}
                            </div>
                        </div>
                    `;
                });
                
                htmlContent += `</div>`;
            } else if (data.totale_de_minimis === 0) {
                htmlContent += `
                    <div style="margin-top: 15px; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                        <p style="color: #a0a0a0;">Nessun aiuto De Minimis trovato per il gruppo.</p>
                    </div>
                `;
            }
            
            htmlContent += `</div>`;
            resultsDiv.innerHTML = htmlContent;
        }
        
        function copiaMarkdownCribisGlobal() {
            if (!risultatoCribisGlobale) {
                alert('‚ùå Errore: dati non trovati');
                return;
            }
            copiaMarkdownCribis(risultatoCribisGlobale);
        }
        
        function copiaMarkdownCribis(data) {
            let markdown = `## üìã Risultato De Minimis Aggregato - ${data.partita_iva}\n\n`;
            
            // Societ√† del gruppo
            if (data.dettaglio_societa && data.dettaglio_societa.length > 0) {
                markdown += `### üè¢ Societ√† del Gruppo (${data.dettaglio_societa.length}):\n`;
                data.dettaglio_societa.forEach(societa => {
                    const importo = formatEuro(societa.totale_de_minimis || 0);
                    markdown += `- **${societa.codice_fiscale}**: ${importo} (${societa.numero_aiuti || 0} aiuti)\n`;
                });
                markdown += `\n`;
            }
            
            // Dettaglio aiuti
            if (data.tutti_aiuti && data.tutti_aiuti.length > 0) {
                markdown += `### üìù Dettaglio Aiuti (Aggregato):\n`;
                markdown += `| Data | Importo | Titolo Misura | Societ√† |\n`;
                markdown += `|------|---------|---------------|----------|\n`;
                
                data.tutti_aiuti.forEach(aiuto => {
                    const importoFormat = formatEuro(aiuto.importo).replace('‚Ç¨', '‚Ç¨ ');
                    const titolo = aiuto.titolo_misura || 'N/A';
                    const dataAiuto = aiuto.data_concessione || aiuto.data;
                    markdown += `| ${dataAiuto} | ${importoFormat} | ${titolo} | ${aiuto.societa_cf} |\n`;
                });
                markdown += `\n`;
            } else {
                markdown += `Nessun aiuto De Minimis trovato per il gruppo.\n\n`;
            }
            
            const totaleFormat = formatEuro(data.totale_de_minimis || 0);
            const margineFormat = formatEuro(data.margine_rimanente || 0);
            markdown += `**Totale De Minimis Aggregato**: ${totaleFormat}\n`;
            markdown += `**Numero aiuti**: ${data.numero_aiuti || 0}\n`;
            markdown += `**Percentuale utilizzata**: ${data.percentuale_utilizzata || 0}%\n`;
            markdown += `**Margine rimanente**: ${margineFormat}\n`;
            markdown += `**Numero societ√†**: ${data.numero_societa || 0}\n`;
            markdown += `**Data ricerca**: ${data.data_ricerca}\n`;
            markdown += `**Fonte**: ${data.fonte || 'Cribis Nuova Ricerca'}\n`;
            
            navigator.clipboard.writeText(markdown).then(() => {
                alert('‚úÖ Risultato aggregato copiato in formato Markdown!');
            }).catch(err => {
                alert('‚ùå Errore nella copia: ' + err);
            });
        }
    </script>
</body>
</html>
